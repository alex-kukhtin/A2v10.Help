<div>
	<!--title:Работа с двоичными объектами -->
	<!--keywords:Blob;-->
	<div class="title">
		<h1>
			Работа с двоичными объектами (blob)
		</h1>
		<div class="breadcrumb">
			<a href="index">Модели данных</a>
		</div>
	</div>

	<h2>Общая информация</h2>

	<p>
		Двоичный объект (это может быть изображение, вложение (attachment) и т.д.)
		представляет собой отдельную сущность. У нее есть свойства <code>Name</code>, <code>Mime</code>
		и непосредственно данные (<code>Stream</code>).
	</p>
	<p>
		Эта сущность может храниться как в отдельной таблице для каждого элемента, так и в общей таблице вложений c дополнительной таблицей связей.
		Для предотвращения несанкционированного доступа к вложениям используется механизм формирования токенов доступа.
		Токен это просто хеш строки, содержащей идентификатор текущей сессии,
		идентификатор пользователя и дополнительный ключ доступа (guid) связанный с этим вложением.
		Проще всего добавить этот ключ в виде поля с типом <code>uniqueidentifier</code> и значением по умолчанию <code>newid()</code>.
	</p>

	<p>
		Работа с двоичными объектами фактически состоит из трех почти независимых частей.
		<ol>
			<li>
				Получение самого объекта и токена доступа.
				Тут все просто и можно использовать стандартные средства платформы.
				Однако загружать сам поток данных сразу не получится. Нужны какие-то отдельные инструменты для работы с этим потоком.
				Простейший вариант – загрузка (download) данных по клику на ссылке.
				Если мы работаем с картинками, имеет смысл показать их Preview. Кроме того, для
				предотвращения несанкционированного доступа необходимо сформировать токен доступа.
				Для этого в набор данных нужно включить поле со специальным типом <code>!Token</code>.
				При обработке этого поля система возьмет значение (это будет guid) и сформирует вместо него токен доступа.
				Обратите внимание, что значения этого токена будут разными в разных сессиях работы с браузером.
			</li>
			<li>
				Получение с сервера байтов (картинки, вложения) с использованием токена доступа.
				Используется для отображения картинок (элементы
				<a class="code-link" href="/xaml/controls/image">Image</a>,
				<a class="code-link" href="/xaml/controls/fileimage">FileImage</a>
				)
				или просто для их загрузки с помощью команды
				<a class="code-link" href="/xaml/bind/bindcmd">File</a>.
			</li>
			<li>
				Выгрузка (upload) данных на сервер.
				Сохранить данные можно где угодно (например в БД или в Azure Storage).
				У этого вложения появляется идентификатор.
				По нему можно получить содержимое для загрузки или отображения двоичных данных (картинки, файла).
				Обратите внимание, что в саму модель этот идентификатор запишется только при сохранении модели.
				Кроме идентификатора загрузки при сохранении данных сформируется токен доступа.
				Его тоже нужно записать в модель (сохранять не нужно, при загрузке он все равно сформируется заново).
			</li>
		</ol>
	</p>

	<h2>Форматы хранимых процедур</h2>

	<p>
		Для работы с двоичными данными используется две хранимые процедуры. Одна для чтения данных (суффикс <code>.Load</code>),
		вторая, для их записи (суффикс <code>.Update</code>). Обратите внимание, что процедуры работы с двоичными данными
		специфические и не соответствуют правилам для построения моделей.
	</p>

	<h4>Процедура <code>.Load</code></h4>
	<p>
		Процедура получает следующие параметры (имена фиксированы, порядок не имеет значения):
		<ul class="std">
			<li><code>@TenantId int</code> - Id тенанта (только в мультитенантном окружении).</li>
			<li><code>@UserId bigint</code> - Id текущего пользователя.</li>
			<li><code>@Id bigint</code> - Id данных (картинки, вложения).</li>
		</ul>
	</p>

	<p>
		Процедура должна вернуть единственный набор данных со следующими полями (имеют значения имена полей,
		порядок произвольный.
		<ul class="std">
			<li><code>Id bigint</code> - Id данных (картинки, вложения).</li>
			<li><code>Mime nvarchar(255)</code> - Mime тип данных.</li>
			<li><code>Name nvarchar(255)</code> - Наименование набора данных.</li>
			<li><code>Stream varbinary(max)</code> - сам поток данных. Может быть равно null</li>
			<li>
				<code>BlobName nvarcvhar(max)</code> - имя набора во внешнем хранилище (например Azure Storage).
				Может быть равно null.
			</li>
			<li>
				<code>Token uniqueidentifier</code> - поле для формирования токена доступа.
				Этот элемент должен соответствовать тому. что возвращет процедура загрузки модели, из
				которой будут получаться эти данные.
			</li>
		</ul>
	</p>

	<p>
		Процедура загрузки должна вернуть одно из полей <code>BlobName</code> или <code>Stream</code>.
		Если задано поле <code>BlobName</code>, то данные будут получены из внешнего хранилища (Azure Storage), а
		значение поля <code>Stream</code> будет проигнорировано.
	</p>


	<h4>Процедура <code>.Update</code></h4>
	<p>
		Процедура получает следующие параметры (имена фиксированы, порядок не имеет значения):
		<ul class="std">
			<li><code>@TenantId int</code> - Id тенанта (только в мультитенантном окружении).</li>
			<li><code>@UserId bigint</code> - Id текущего пользователя.</li>
			<li><code>@Name nvarchar(255)</code> - Наименование набора данных.</li>
			<li><code>@Mime nvarchar(255)</code> - Mime тип данных.</li>
			<li><code>@Stream varbinary(max)</code> - сам поток данных или null, если данные сохранены во внешнем хранилище.</li>
			<li><code>@BlobName nvarcvhar(max)</code> - имя набора во внешнем хранилище или null.</li>
		</ul>
	</p>

	<p>
		Процедура должна вернуть единственный набор со следующими полями (имеют значение имена полей,
		порядок не важен)
		<ul class="std">
			<li><code>Id bigint</code> - Id данных (картинки, вложения).</li>
			<li>
				<code>Token uniqueidentifier</code> - поле для формирования токена доступа.
			</li>
		</ul>
	</p>

	<p>Данные, котрые вернет эта процедура будут возвращены на клиент, который должен будет добавить их к своей модели данных.</p>


	<h2>Смотри также</h2>

	<p>
		<ul class=" std">
			<li>Элемент управления <a class="code-link" href="/xaml/controls/image">Image</a>.</li>
			<li>Элемент управления <a class="code-link" href="/xaml/controls/fileimage">FileImage</a>.</li>
			<li>Элемент управления <a class="code-link" href="/xaml/controls/uploadfile">UploadFile</a>.</li>
			<li>Команда <a class="code-link" href="/xaml/bind/bindcmd">File</a>.</li>
			<li>Раздел <a class="code-link" href="/app/files">files</a> файла <code>model.json</code>.</li>
		</ul>
	</p>
</div>