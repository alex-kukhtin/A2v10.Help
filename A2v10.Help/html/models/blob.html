<div>
	<!--title:Робота з бінарними об'єктами -->
	<!--keywords:Blob;-->
	<div class="title">
		<h1>
			Робота з бінарними об'єктами (blob)
		</h1>
		<div class="breadcrumb">
			<a href="index">Моделі даних</a>
		</div>
	</div>

	<h2>Загальна інформація</h2>

	<p>
		Бінарний об`єкт (це може бути зображення, вкладення (attachment) тощо)
		являє собою окрему сутність. У неї є властивості <code>Name</code>, <code>Mime</code>
		і безпосередньо дані (<code>Stream</code>).
	</p>
	<p>
		Ця сутність може зберігатися як в окремій таблиці для кожного елементу, так і в загальній таблиці вкладень з додатковою таблицею зв'язків.
		Для запобігання несанкціонованому доступу до вкладень використовується механізм формуваня токенів доступу.
		Токен це просто хеш рядка, що містить ідентифікатор поточної сесії,
		ідентифікатор користувача і додатковий ключ доступу (guid), зв'язаний з цим вкладенням.
		Простіше за все додати цей ключ у вигляді поля з типом <code>uniqueidentifier</code> і значенням за замовчуванням <code>newid()</code>.
	</p>

	<p>
		Робота з бінарними об'єктами фактично складається з трьох майже незалежних частин.
		<ol>
			<li>
				Отримання самого об'єкта і токена доступу.
				Тут все просто і можна використовувати стандартні засоби платформи.
				Однак завантажувати сам потік даних одразу не вийде. Потрібні якісь окремі інструменти для роботи з цим потоком.
				Найпростіший варіант – завантаження (download) даних по кліку на посилання.
				Якщо ми працюємо з зображеннями, є сенс показати їх попереднє відображення (Preview). Крім того, для
				уникнення несанкціонованому доступу необхідно сформувати токен доступу.
				Для цього в набір даних потрібно включити поле з спеціальним типом <code>!Token</code>.
				При обробці цього поля система візьме значення (це буде guid) і сформує замість нього токен доступу.
				Зверніть увагу, що значення цього токена будуть різними в різних сесіях роботи з браузером.
			</li>
			<li>
				Отримання з сервера байтів (зображення, вкладення) з використанням токена доступу.
				Використовується для відображення зображень (елементи
				<a class="code-link" href="/xaml/controls/image">Image</a>,
				<a class="code-link" href="/xaml/controls/fileimage">FileImage</a>
				)
				або просто для їх завантаження за допомогою команди
				<a class="code-link" href="/xaml/bind/bindcmd">File</a>.
			</li>
			<li>
				Вивантаження (upload) даних на сервер.
				Зберігти дані можна де завгодно (наприклад в БД або в Azure Storage).
				У цього вкладення з'являється ідентифікатор.
				По ньому можна отримати вміст для завантаження або відображення бінарних даних (зображення, файлу).
				Зверніть увагу, що в саму модель цей ідентифікатор запишеться тільки при збереженні моделі.
				Крім ідентифікатора завантаження при збереженні даних сформується токен доступу.
				Його також потрібно записати в модель (зберігати не потрібно, при завантаженні він все одно сформується заново).
			</li>
		</ol>
	</p>

	<h2>Формати збережених процедур</h2>

	<p>
		Для роботи з бінарними даними використовується дві збережені процедури. Одна для читання даних (суфікс <code>.Load</code>),
		друга для їх запису (суфікс <code>.Update</code>). Зверніть увагу, що процедури роботи з бінарними даними
		специфічні і не відповідають правилам для побудови моделей.
	</p>

	<h4>Процедура <code>.Load</code></h4>
	<p>
		Процедура отримує наступні параметри (імена фіксовані, порядок не має значення):
		<ul class="std">
			<li><code>@TenantId int</code> - Id тенанта (тільки в мультитенантному середовищі).</li>
			<li><code>@UserId bigint</code> - Id поточного користувача.</li>
			<li><code>@Id bigint</code> - Id даних (зображення, вкладення).</li>
		</ul>
	</p>

	<p>
		Процедура повинна повернути єдиний набір даних з наступними полями (мають значення імена полів,
		порядок довільний).
		<ul class="std">
			<li><code>Id bigint</code> - Id даних (зображення, вкладення).</li>
			<li><code>Mime nvarchar(255)</code> - Mime тип даних.</li>
			<li><code>Name nvarchar(255)</code> - Найменування набору даних.</li>
			<li><code>Stream varbinary(max)</code> - сам потік даних. Може дорівнювати null</li>
			<li>
				<code>BlobName nvarcvhar(max)</code> - ім'я набору в зовнішньому сховищі (наприклад Azure Storage).
				Може дорівнювати null.
			</li>
			<li>
				<code>Token uniqueidentifier</code> - поле для формування токена доступу.
				Цей елемент повинен відповідати тому, що повертає процедура завантаження моделі, з
				якої будуть отримуватися ці дані.
			</li>
		</ul>
	</p>

	<p>
		Процедура завантаження повинна повернути одне з полів <code>BlobName</code> або <code>Stream</code>.
		Якщо задано поле <code>BlobName</code>, то дані будуть отримані з зовнішнього сховища (Azure Storage), а
		значення поля <code>Stream</code> буде проігноровано.
	</p>


	<h4>Процедура <code>.Update</code></h4>
	<p>
		Процедура отримує наступні параметри (імена фіксовані, порядок не має значення):
		<ul class="std">
			<li><code>@TenantId int</code> - Id тенанта (тільки в мультитенантному середовищі).</li>
			<li><code>@UserId bigint</code> - Id поточного користувача.</li>
			<li><code>@Name nvarchar(255)</code> - Найменування набору даних.</li>
			<li><code>@Mime nvarchar(255)</code> - Mime тип даних.</li>
			<li><code>@Stream varbinary(max)</code> - сам потік даних або null, якщо дані збережені у зовнішньому сховищі.</li>
			<li><code>@BlobName nvarcvhar(max)</code> - ім'я набору у зовнішньому сховищі або null.</li>
		</ul>
	</p>

	<p>
		Процедура повинна повернути єдиний набір з наступними полями (мають значення імена полів,
		порядок не має значення)
		<ul class="std">
			<li><code>Id bigint</code> - Id даних (зображення, вкладення).</li>
			<li>
				<code>Token uniqueidentifier</code> - поле для формуваня токена доступу.
			</li>
		</ul>
	</p>

	<p>Дані, які поверне ця процедура, будуть повернені на клієнт, який повинен буде додати їх до своєї моделі даних.</p>


	<h2>Дивись також</h2>

	<p>
		<ul class=" std">
			<li>Елемент керування <a class="code-link" href="/xaml/controls/image">Image</a>.</li>
			<li>Елемент керування <a class="code-link" href="/xaml/controls/fileimage">FileImage</a>.</li>
			<li>Елемент керування <a class="code-link" href="/xaml/controls/uploadfile">UploadFile</a>.</li>
			<li>Команда <a class="code-link" href="/xaml/bind/bindcmd">File</a>.</li>
			<li>Розділ <a class="code-link" href="/app/files">files</a> файла <code>model.json</code>.</li>
		</ul>
	</p>
</div>