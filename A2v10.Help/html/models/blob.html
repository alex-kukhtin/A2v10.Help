<div>
	<!--title:Робота с двоичными об'єктами -->
	<!--keywords:Blob;-->
	<div class="title">
		<h1>
			Робота с двоичными об'єктами (blob)
		</h1>
		<div class="breadcrumb">
			<a href="index">Моделі даних</a>
		</div>
	</div>

	<h2>Загальна інформація</h2>

	<p>
		Двоичный об`єкт (это може бути изображение, вложение (attachment) і т.д.)
		являє собою окрему сущность. У нее є властивості <code>Name</code>, <code>Mime</code>
		и безпосередньо дані (<code>Stream</code>).
	</p>
	<p>
		Ця сущность може храниться як в отдельной таблице для каждого елементу, так і в общей таблице вложений c додатковой таблицей связей.
		Для предотвращения несанкционированного доступа к вкладенням використовується механизм формирования токенов доступа.
		Токен це просто хеш строки, содержащей ідентифікатор поточної сессии,
		ідентифікатор користувача і дополнительный ключ доступа (guid) связанный с этим вложением.
		Проще всього добавить цей ключ у вигляді поля с типом <code>uniqueidentifier</code> і значенням за замовчанням <code>newid()</code>.
	</p>

	<p>
		Робота с двоичными об'єктами фактически состоит з трех почти независимых частей.
		<ol>
			<li>
				Получение самого об'єкта і токена доступа.
				Тут всі просто і можна використовувати стандартные средства платформи.
				Однако загружать сам поток даних сразу не получится. Нужны якісь отдельные инструменты для роботи с этим потоком.
				Простейший вариант – загрузка (download) даних по клику на ссылке.
				Якщо мы работаем с картинками, має смысл показать их Preview. Крім того, для
				предотвращения несанкционированного доступа необхідно сформировать токен доступа.
				Для цього в набір даних потрібно включить поле со специальным типом <code>!Token</code>.
				При обработке цього поля система возьмет значення (это буде guid) і сформує вмісце нього токен доступа.
				Зверніть увагу, що значення цього токена будуть разными в разных сессиях роботи с браузером.
			</li>
			<li>
				Получение с сервера байтів (картинки, вкладення) з використанням токена доступа.
				Використовується для отображения зображень (елементи
				<a class="code-link" href="/xaml/controls/image">Image</a>,
				<a class="code-link" href="/xaml/controls/fileimage">FileImage</a>
				)
				або просто для их завантаження за допомогою команди
				<a class="code-link" href="/xaml/bind/bindcmd">File</a>.
			</li>
			<li>
				Выгрузка (upload) даних на сервер.
				Сохранить дані можна де  угодно (наприклад в БД або в Azure Storage).
				У цього вкладення появляется идентификатор.
				По нему можна отримати вміст для завантаження або отображения двоичных даних (картинки, файла).
				Зверніть увагу, що в саму модель цей ідентифікатор запишется тільки при сохранении моделі.
				Крім идентификатора завантаження при сохранении даних сформується токен доступа.
				Его тоже потрібно записать в модель (сохранять не потрібно, при завантаженні він всі дорівнює сформується заново).
			</li>
		</ol>
	</p>

	<h2>Форматы хранимых процедур</h2>

	<p>
		Для роботи с двоичными даними використовується две хранимые процедури. Одна для чтения даних (суффикс <code>.Load</code>),
		вторая, для их записи (суффикс <code>.Update</code>). Зверніть увагу, що процедури роботи с двоичными данными
		специфические і не соответствуют правилам для побудови моделей.
	</p>

	<h4>Процедура <code>.Load</code></h4>
	<p>
		Процедура получает наступні параметри (імена фиксированы, порядок не має значения):
		<ul class="std">
			<li><code>@TenantId int</code> - Id тенанта (тільки в мультитенантном середовищі).</li>
			<li><code>@UserId bigint</code> - Id поточного користувача.</li>
			<li><code>@Id bigint</code> - Id даних (картинки, вкладення).</li>
		</ul>
	</p>

	<p>
		Процедура повинна повернути единственный набір даних со наступними полями (имеют значення імена полей,
		порядок довільний.
		<ul class="std">
			<li><code>Id bigint</code> - Id даних (картинки, вкладення).</li>
			<li><code>Mime nvarchar(255)</code> - Mime тип даних.</li>
			<li><code>Name nvarchar(255)</code> - Наименование набіра даних.</li>
			<li><code>Stream varbinary(max)</code> - сам поток даних. Може бути дорівнює null</li>
			<li>
				<code>BlobName nvarcvhar(max)</code> - ім'янабора во внешнем хранилище (наприклад Azure Storage).
				Може бути дорівнює null.
			</li>
			<li>
				<code>Token uniqueidentifier</code> - поле для формирования токена доступа.
				Этот елемент повинен соответствовать тому. що возвращет процедура завантаження моделі, из
				которой будуть получаться эти дані.
			</li>
		</ul>
	</p>

	<p>
		Процедура завантаження повинна повернути одно з полей <code>BlobName</code> або <code>Stream</code>.
		Якщо задано поле <code>BlobName</code>, то дані будуть получены з зовнішнього хранилища (Azure Storage), а
		значення поля <code>Stream</code> буде проигнорировано.
	</p>


	<h4>Процедура <code>.Update</code></h4>
	<p>
		Процедура получает наступні параметри (імена фиксированы, порядок не має значения):
		<ul class="std">
			<li><code>@TenantId int</code> - Id тенанта (тільки в мультитенантном середовищі).</li>
			<li><code>@UserId bigint</code> - Id поточного користувача.</li>
			<li><code>@Name nvarchar(255)</code> - Наименование набіра даних.</li>
			<li><code>@Mime nvarchar(255)</code> - Mime тип даних.</li>
			<li><code>@Stream varbinary(max)</code> - сам поток даних або null, якщо дані сохранены во внешнем хранилище.</li>
			<li><code>@BlobName nvarcvhar(max)</code> - ім'янабора во внешнем хранилище або null.</li>
		</ul>
	</p>

	<p>
		Процедура повинна повернути единственный набір со наступними полями (имеют значення імена полей,
		порядок не важен)
		<ul class="std">
			<li><code>Id bigint</code> - Id даних (картинки, вкладення).</li>
			<li>
				<code>Token uniqueidentifier</code> - поле для формирования токена доступа.
			</li>
		</ul>
	</p>

	<p>Дані, котрые вернет эта процедура будуть возвращены на клієнті, который повинен буде добавить их к своей моделі даних.</p>


	<h2>Смотри також</h2>

	<p>
		<ul class=" std">
			<li>Елемент керування <a class="code-link" href="/xaml/controls/image">Image</a>.</li>
			<li>Елемент керування <a class="code-link" href="/xaml/controls/fileimage">FileImage</a>.</li>
			<li>Елемент керування <a class="code-link" href="/xaml/controls/uploadfile">UploadFile</a>.</li>
			<li>Команда <a class="code-link" href="/xaml/bind/bindcmd">File</a>.</li>
			<li>Раздел <a class="code-link" href="/app/files">files</a> файла <code>model.json</code>.</li>
		</ul>
	</p>
</div>